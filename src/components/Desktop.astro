---
import ThemeToggle from './ui/ThemeToggle.astro'
import DesktopIcon from './ui/DesktopIcon.astro'
import CherryBlossoms from './features/CherryBlossoms.astro'
import WindowContent from './WindowContent.astro'
import { USER_NAME, CURRENT_YEAR, SOCIAL_LINKS, USER_EMAIL } from '../lib/constants'
import { Image } from 'astro:assets'

const base = import.meta.env.BASE_URL ?? '/'
---

<div class="desktop">
  <CherryBlossoms />
  
  <div class="decorations">
    <div class="sakura-decoration">
      <Image src={`${base}images/sakura.webp`} alt="Sakura decoration" width={400} height={300} />
    </div>
    <div class="lily-decoration hidden">
      <Image src={`${base}images/lily.webp`} alt="Lily decoration" width={300} height={200} class="lily-1" />
      <Image src={`${base}images/lily.webp`} alt="Lily decoration" width={250} height={180} class="lily-2" />
    </div>
  </div>

  <div class="controls">
    <ThemeToggle />
  </div>

  <div class="desktop-content">
    <div class="home-window" id="home-window">
      <header class="home-header">
        <span id="greeting" class="greeting" lang="ja">こんにちは！</span>
      </header>
      <div class="icon-grid">
        <DesktopIcon id="about" name="about" />
        <DesktopIcon id="links" name="links" />
        <DesktopIcon id="work" name="work" />
        <DesktopIcon id="faq" name="faq" />
      </div>
    </div>
  </div>

  <p class="konami-hint">Hint: try the Konami code</p>

  <div id="windows-container" class="windows-container"></div>

  <div id="konami-controller" class="konami-controller hidden">
    <div class="controller-header">
      <h3>Controller</h3>
      <button id="controller-close" aria-label="Close controller">×</button>
    </div>
    <div class="controller-body">
      <div class="sequence-progress">
        <span class="dot" data-index="0"></span>
        <span class="dot" data-index="1"></span>
        <span class="dot" data-index="2"></span>
        <span class="dot" data-index="3"></span>
        <span class="dot" data-index="4"></span>
        <span class="dot" data-index="5"></span>
        <span class="dot" data-index="6"></span>
        <span class="dot" data-index="7"></span>
        <span class="dot" data-index="8"></span>
        <span class="dot" data-index="9"></span>
      </div>
      <jpad-controller>
        <div class="dpad">
          <jpad-button id="btn-up" name="up" keys="ArrowUp">↑</jpad-button>
          <jpad-button id="btn-down" name="down" keys="ArrowDown">↓</jpad-button>
          <jpad-button id="btn-left" name="left" keys="ArrowLeft">←</jpad-button>
          <jpad-button id="btn-right" name="right" keys="ArrowRight">→</jpad-button>
        </div>
        <div class="action-buttons">
          <jpad-button id="btn-b" name="b" keys="KeyB">B</jpad-button>
          <jpad-button id="btn-a" name="a" keys="KeyA">A</jpad-button>
        </div>
      </jpad-controller>
    </div>
  </div>

  <WindowContent />

<script>
  import { $windows, $sortedWindows, $activeWindowId, openWindow, closeWindow } from '../stores/windows'
  import { renderWindow } from '../lib/windowRenderer'
  import 'jpad-components'

  function createWindowEl(state: { id: string; title: string; position: { x: number; y: number }; size: { width: number; height: number }; zIndex: number; isLoading: boolean }): HTMLElement {
    const el = document.createElement('div')
    el.className = 'window'
    el.dataset.windowId = state.id
    el.style.cssText = `left: ${state.position.x}px; top: ${state.position.y}px; width: ${state.size.width}px; height: ${state.size.height}px; z-index: ${state.zIndex};`
    
    el.innerHTML = `
      <header class="window-header" data-drag-handle>
        <span class="window-title">${state.title}</span>
        <button class="window-close" aria-label="Close ${state.title}" data-close>×</button>
      </header>
      <main class="window-content"></main>
    `
    
    requestAnimationFrame(() => {
      el.classList.add('is-open')
      renderWindow(state.id, el)
    })
    
    return el
  }

  function syncWindows(): void {
    const container = document.getElementById('windows-container')
    if (!container) return

    const windows = $sortedWindows.get()
    const activeId = $activeWindowId.get()
    const existingEls = new Map<string, HTMLElement>()
    
    container.querySelectorAll('.window').forEach(el => {
      const id = (el as HTMLElement).dataset.windowId
      if (id) existingEls.set(id, el as HTMLElement)
    })

    const currentIds = new Set(windows.map(w => w.id))
    
    existingEls.forEach((el, id) => {
      if (!currentIds.has(id)) {
        el.remove()
      }
    })

    windows.forEach(state => {
      let el = existingEls.get(state.id)
      
      if (!el) {
        el = createWindowEl(state)
        container.appendChild(el)
      } else {
        el.style.left = `${state.position.x}px`
        el.style.top = `${state.position.y}px`
        el.style.zIndex = String(state.zIndex)
        el.classList.toggle('is-active', state.id === activeId)
      }
    })
  }

  function initKonamiCode(): void {
    const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'KeyB', 'KeyA']
    let konamiIndex = 0

    function updateSequenceDots(): void {
      const dots = document.querySelectorAll('#konami-controller .dot')
      dots.forEach((dot, i) => {
        if (i < konamiIndex) {
          dot.classList.add('active')
        } else {
          dot.classList.remove('active')
        }
      })
    }

    function triggerAutism(): void {
      document.body.classList.add('konami-activated')
      setTimeout(() => {
        document.body.classList.remove('konami-activated')
      }, 500)
      
      openWindow('autism')
      hideController()
      konamiIndex = 0
      updateSequenceDots()
    }

    function handleKonamiInput(key: string): void {
      const expectedKey = konamiCode[konamiIndex]
      
      if (key === expectedKey) {
        konamiIndex++
        updateSequenceDots()
        
        if (konamiIndex === konamiCode.length) {
          setTimeout(triggerAutism, 300)
        }
      } else {
        konamiIndex = 0
        updateSequenceDots()
      }
    }

    function handleKeyDown(e: KeyboardEvent): void {
      handleKonamiInput(e.code)
    }

    function showController(): void {
      const controller = document.getElementById('konami-controller')
      controller?.classList.remove('hidden')
      konamiIndex = 0
      updateSequenceDots()
    }

    function hideController(): void {
      const controller = document.getElementById('konami-controller')
      controller?.classList.add('hidden')
      konamiIndex = 0
      updateSequenceDots()
    }

    function initControllerButtons(): void {
      const buttons = [
        { id: 'btn-up', key: 'ArrowUp' },
        { id: 'btn-down', key: 'ArrowDown' },
        { id: 'btn-left', key: 'ArrowLeft' },
        { id: 'btn-right', key: 'ArrowRight' },
        { id: 'btn-a', key: 'KeyA' },
        { id: 'btn-b', key: 'KeyB' },
      ]

      buttons.forEach(({ id, key }) => {
        const btn = document.getElementById(id)
        btn?.addEventListener('click', () => handleKonamiInput(key))
      })

      document.getElementById('controller-close')?.addEventListener('click', hideController)
    }

    function setupControllerTrigger(): void {
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'childList') {
            const triggerPanel = document.getElementById('controller-trigger-panel')
            if (triggerPanel && !triggerPanel.hasAttribute('data-initialized')) {
              triggerPanel.addEventListener('click', () => {
                closeWindow('faq')
                setTimeout(showController, 350)
              })
              triggerPanel.setAttribute('data-initialized', 'true')
            }
          }
        })
      })

      observer.observe(document.body, { childList: true, subtree: true })
    }

    document.addEventListener('keydown', handleKeyDown)
    initControllerButtons()
    setupControllerTrigger()
  }

  document.addEventListener('astro:page-load', () => {
    $windows.subscribe(syncWindows)
    $activeWindowId.subscribe(syncWindows)
    initKonamiCode()
    updateGreeting()
  })

  function updateGreeting(): void {
    const greetingEl = document.getElementById('greeting')
    if (!greetingEl) return
    
    const hour = new Date().getHours()
    const isNight = hour >= 18 || hour < 6
    greetingEl.textContent = isNight ? 'こんばんわ！' : 'こんにちは！'
  }
</script>

  <video
    id="lain-bg-video"
    autoplay
    loop
    muted
    playsinline
    class="lain-video hidden"
  >
    <source src={`${base}images/lain.webm`} type="video/webm" />
  </video>

  <footer class="footer">
    <span class="copyright">&copy; {CURRENT_YEAR} {USER_NAME}</span>
  </footer>
</div>

<style>
  .desktop {
    display: flex;
    flex-direction: column;
    height: 100vh;
    position: relative;
    background-color: var(--window-bg);
  }

  .decorations {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
  }

  .sakura-decoration {
    position: absolute;
    bottom: 0;
    left: 0;
    max-width: 400px;
    max-height: 400px;
    opacity: 0.9;
    transform-origin: bottom left;
    animation: float 8s ease-in-out infinite;
  }

  .sakura-decoration img {
    width: 100%;
    height: auto;
    filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
  }

  :global(.dark) .sakura-decoration img {
    filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.3)) brightness(0.9);
  }

  .lily-decoration {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
  }

  .lily-1 {
    position: absolute;
    bottom: -20px;
    left: -20px;
    width: 300px;
    transform: scale(1.2) rotate(-5deg);
    animation: float 8s ease-in-out infinite;
  }

  .lily-2 {
    position: absolute;
    bottom: -10px;
    left: 120px;
    width: 250px;
    transform: scale(0.9) rotate(8deg);
    animation: float 10s ease-in-out infinite reverse;
    z-index: 2;
  }

  :global(.dark) .lily-1,
  :global(.dark) .lily-2 {
    filter: brightness(0.7) hue-rotate(30deg);
  }

  .controls {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 100;
  }

  .desktop-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
    z-index: 10;
  }

  .home-window {
    background-color: var(--window-content-bg);
    border: 3px solid var(--window-title-bg);
    border-radius: 15px;
    padding: 2rem;
    box-shadow: var(--window-shadow);
    z-index: 5;
  }

  .home-header {
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .greeting {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-color);
  }

  .icon-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    justify-items: center;
  }

  .windows-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 20;
  }

  .lain-video {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 0;
    pointer-events: none;
  }

  .footer {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 1rem;
    display: flex;
    justify-content: center;
    z-index: 10;
  }

  .copyright {
    font-size: 0.875rem;
    color: var(--text-color);
    opacity: 0.8;
  }

  .konami-hint {
    position: absolute;
    bottom: 2.5rem;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.7rem;
    color: var(--text-color);
    opacity: 0.4;
    z-index: 5;
  }

  .konami-controller {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 3px solid #e94560;
    border-radius: 15px;
    padding: 1.5rem;
    z-index: 1000;
    box-shadow: 0 0 30px rgba(233, 69, 96, 0.3);
    min-width: 280px;
  }

  .konami-controller.hidden {
    display: none;
  }

  .controller-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e94560;
  }

  .controller-header h3 {
    color: #e94560;
    font-size: 1rem;
    margin: 0;
  }

  .controller-header button {
    background: transparent;
    border: none;
    color: #e94560;
    font-size: 1.25rem;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
  }

  .controller-header button:hover {
    color: #ff6b6b;
  }

  .sequence-progress {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .sequence-progress .dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #333;
    border: 2px solid #e94560;
    transition: all 0.2s ease;
  }

  .sequence-progress .dot.active {
    background: #e94560;
    box-shadow: 0 0 10px #e94560;
  }

  .controller-body jpad-controller {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .dpad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    gap: 0.25rem;
    width: 120px;
  }

  .dpad jpad-button {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #0f3460;
    border: 2px solid #e94560;
    color: #e94560;
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
  }

  .dpad jpad-button:hover {
    background: #e94560;
    color: #1a1a2e;
  }

  .dpad jpad-button:nth-child(1) { grid-column: 2; grid-row: 1; }
  .dpad jpad-button:nth-child(2) { grid-column: 2; grid-row: 3; }
  .dpad jpad-button:nth-child(3) { grid-column: 1; grid-row: 2; }
  .dpad jpad-button:nth-child(4) { grid-column: 3; grid-row: 2; }

  .action-buttons {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
  }

  .action-buttons jpad-button {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    font-size: 1.25rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .action-buttons jpad-button#btn-b {
    background: #1a1a2e;
    border: 3px solid #e94560;
    color: #e94560;
  }

  .action-buttons jpad-button#btn-a {
    background: #e94560;
    border: 3px solid #ff6b6b;
    color: #1a1a2e;
  }

  .action-buttons jpad-button:hover {
    transform: scale(1.1);
  }

  @media (max-width: 640px) {
    .home-window {
      padding: 1.5rem;
    }

    .greeting {
      font-size: 1.25rem;
    }

    .sakura-decoration {
      max-width: 250px;
      transform: scale(0.6);
    }
  }
</style>